<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <title>Cesium 3D</title>
    <style type="text/css">
        body,
        html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #cesiumContainer {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>
    <select id="category-selector" style="z-index: 1; position: fixed; top: 5px; left: 5px;">
        <option value="todos">Todos</option>
        <option value="historico">Histórico</option>
        <option value="servicos">Serviços</option>
        <option value="casas antigas">Casas Antigas</option>
        <option value="clube">Clube</option>
        <option value="Café">Café</option>
        <option value="farmácia">Farmácia</option>
        <option value="igreja">Igreja</option>
        <option value="posto gasolina">Posto de Gasolina</option>
        <option value="Prefeitura Municipal">Prefeitura Municipal</option>
    </select>

    <script type="module">

    import { buildingsMap } from './buildingsData.js';
    import { lendas } from './lendasData.js';

        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5NmUwYzg1Zi1lMGI3LTQ4ZmYtYTI4MC04ZjQyYmYwY2Y2NjgiLCJpZCI6MTI5NjcwLCJpYXQiOjE3NTc4NjMzNTR9.ktheFtRHsrg2EOCenwduLGJWJyCKVfAD3q64qdlUzt8';

        let viewer;
        async function init() {
            try {
                // Inicializa o visualizador com terreno
                viewer = new Cesium.Viewer('cesiumContainer', {
                    terrain: Cesium.Terrain.fromWorldTerrain(),
                    infoBox: false,
                    selectionIndicator: false,
                    animation: false,
                    timeline: false,
                    baseLayerPicker: false,
                });

                // Controles da câmera
                viewer.scene.screenSpaceCameraController.rotateEventTypes = [Cesium.CameraEventType.LEFT_DRAG];
                viewer.scene.screenSpaceCameraController.zoomEventTypes = [Cesium.CameraEventType.MIDDLE_DRAG, Cesium.CameraEventType.WHEEL, Cesium.CameraEventType.PINCH];
                viewer.scene.screenSpaceCameraController.panEventTypes = [Cesium.CameraEventType.RIGHT_DRAG];

                // Visão global e depois área de interesse (centro da praça)
                const pracaCentro = { lon: -54.316822, lat: -30.344800, altura: 600 };
                viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(pracaCentro.lon, pracaCentro.lat, 20000000),
                });
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(pracaCentro.lon, pracaCentro.lat, pracaCentro.altura),
                    orientation: {
                        heading: Cesium.Math.toRadians(0.0),
                        pitch: Cesium.Math.toRadians(-45.0),
                        roll: 0.0
                    },
                    duration: 3.5,
                    easingFunction: Cesium.EasingFunction.QUADRATIC_IN_OUT
                });

                // Adiciona marcadores das lendas
                const lendaEntities = [];
                lendas.forEach((lenda, idx) => {
                    const entity = viewer.entities.add({
                        position: Cesium.Cartesian3.fromDegrees(lenda.position.lon, lenda.position.lat, 5), // 5 metros acima do solo
                        billboard: {
                            image: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                            width: 40,
                            height: 40,
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND
                        },
                        lendaId: idx
                    });
                    lendaEntities.push(entity);
                });

                // Função para mostrar infobox de lenda com carrossel
                function showLendaInfobox(idx) {
                    const lenda = lendas[idx];
                    if (!lenda) return;
                    let infobox = document.getElementById('infobox-lenda');
                    if (!infobox) {
                        infobox = document.createElement('div');
                        infobox.id = 'infobox-lenda';
                        infobox.style.position = 'fixed';
                        infobox.style.top = '60px';
                        infobox.style.right = '20px';
                        infobox.style.background = 'rgba(255,255,255,0.97)';
                        infobox.style.border = '1px solid #888';
                        infobox.style.padding = '16px';
                        infobox.style.zIndex = 20;
                        infobox.style.maxWidth = '350px';
                        infobox.style.boxShadow = '0 2px 8px #0003';
                        infobox.style.borderRadius = '8px';
                        infobox.style.overflowY = 'auto';
                        document.body.appendChild(infobox);
                    }
                    let carousel = '';
                    if (lenda.images && lenda.images.length > 0) {
                        carousel = `
                        <div id="carousel-lenda" style="text-align:center;">
                            <img id="carousel-img" src="${lenda.images[0]}" style="max-width:95%;max-height:180px;border-radius:6px;" />
                            <br>
                            <button id="prev-img">◀</button>
                            <span id="img-indicator">1/${lenda.images.length}</span>
                            <button id="next-img">▶</button>
                        </div>`;
                    }
                    infobox.innerHTML = `
                        <b>${lenda.title}</b><br><br>
                        <div style='max-height:120px;overflow-y:auto;'>${lenda.description}</div>
                        <br>
                        ${carousel}
                        <br><button id='close-infobox-lenda'>Fechar</button>
                    `;
                    infobox.style.display = 'block';
                    document.getElementById('close-infobox-lenda').onclick = () => {
                        infobox.style.display = 'none';
                    };
                    // Carrossel de imagens
                    if (lenda.images && lenda.images.length > 1) {
                        let idxImg = 0;
                        const imgEl = document.getElementById('carousel-img');
                        const indicator = document.getElementById('img-indicator');
                        document.getElementById('prev-img').onclick = () => {
                            idxImg = (idxImg - 1 + lenda.images.length) % lenda.images.length;
                            imgEl.src = lenda.images[idxImg];
                            indicator.textContent = `${idxImg+1}/${lenda.images.length}`;
                        };
                        document.getElementById('next-img').onclick = () => {
                            idxImg = (idxImg + 1) % lenda.images.length;
                            imgEl.src = lenda.images[idxImg];
                            indicator.textContent = `${idxImg+1}/${lenda.images.length}`;
                        };
                    }
                }

                // Adiciona OSM Buildings tileset
                const buildingsTileset = await Cesium.createOsmBuildingsAsync();
                viewer.scene.primitives.add(buildingsTileset);
                buildingsTileset.style = new Cesium.Cesium3DTileStyle({
                    show: true,
                    color: "color('white', 1)"
                });

                // Evento de clique para mostrar ID e coordenadas do prédio OSM
                viewer.screenSpaceEventHandler.setInputAction(function (click) {
                    const pickedObject = viewer.scene.pick(click.position);
                    if (Cesium.defined(pickedObject) && pickedObject.getProperty) {
                        const elementId = pickedObject.getProperty('elementId');
                        if (elementId) {
                            // Obtém coordenadas do clique
                            const cartesian = viewer.scene.pickPosition(click.position);
                            let coords = null;
                            if (cartesian) {
                                const cartographic = Cesium.Cartographic.fromCartesian(cartesian);
                                const lon = Cesium.Math.toDegrees(cartographic.longitude).toFixed(6);
                                const lat = Cesium.Math.toDegrees(cartographic.latitude).toFixed(6);
                                const height = cartographic.height.toFixed(2);
                                coords = { lon, lat, height };
                            }
                            console.log('ID do prédio:', elementId, 'Coordenadas:', coords);
                        }
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
                // Lógica de alternância OSM/GLB
                let glbEntities = {};

                // Cria/mostra infobox
                function showInfobox(id) {
                    const data = buildingsMap[id];
                    if (!data || !data.info) return;
                    let infobox = document.getElementById('infobox');
                    if (!infobox) {
                        infobox = document.createElement('div');
                        infobox.id = 'infobox';
                        infobox.style.position = 'fixed';
                        infobox.style.top = '20px';
                        infobox.style.right = '20px';
                        infobox.style.background = 'rgba(255,255,255,0.95)';
                        infobox.style.border = '1px solid #888';
                        infobox.style.padding = '16px';
                        infobox.style.zIndex = 10;
                        infobox.style.maxWidth = '320px';
                        infobox.style.boxShadow = '0 2px 8px #0003';
                        infobox.style.borderRadius = '8px';
                        infobox.innerHTML = '';
                        document.body.appendChild(infobox);
                    }
                    infobox.innerHTML = `<b>${data.info.title}</b><br><small>${id}</small><br><br>${data.info.description}<br><br>${data.info.images && data.info.images.length ? `<img src='${data.info.images[0]}' style='max-width:100%;border-radius:6px;'>` : ''}<br><br><button id='close-infobox'>Fechar</button> <button id='close-glb'>Fechar e voltar para OSM</button>`;
                    document.getElementById('close-infobox').onclick = () => {
                        infobox.style.display = 'none';
                    };
                    document.getElementById('close-glb').onclick = () => {
                        infobox.style.display = 'none';
                        if (glbEntities[id]) {
                            viewer.entities.remove(glbEntities[id]);
                            glbEntities[id] = null;
                        }
                        // Reexibe apenas o OSM deste prédio, mantendo os outros ocultos se ainda houver GLB ativo
                        const hideIds = Object.keys(glbEntities).filter(key => glbEntities[key]);
                        const conditions = hideIds.map(hid => [`\${elementId} === ${hid}`, false]);
                        conditions.push([true, true]);
                        buildingsTileset.style = new Cesium.Cesium3DTileStyle({
                            show: { conditions }
                        });
                    };
                    infobox.style.display = 'block';
                }

                function toggleOsmAndGlb(id) {
                    // Oculta OSM apenas do prédio clicado, mantendo os outros como estão
                    // Monta condições para ocultar todos os prédios que já têm GLB ativo
                    const hideIds = Object.keys(glbEntities).filter(key => glbEntities[key]).concat(id);
                    const conditions = hideIds.map(hid => [`\${elementId} === ${hid}`, false]);
                    conditions.push([true, true]);
                    buildingsTileset.style = new Cesium.Cesium3DTileStyle({
                        show: { conditions }
                    });
                    // Permite múltiplos GLBs abertos, cada um substitui seu OSM
                    if (glbEntities[id]) {
                        viewer.entities.remove(glbEntities[id]);
                        glbEntities[id] = null;
                    }
                    const data = buildingsMap[id];
                    if (data) {
                        glbEntities[id] = viewer.entities.add({
                            id: id,
                            position: data.position,
                            orientation: Cesium.Transforms.headingPitchRollQuaternion(
                                data.position,
                                data.orientation
                            ),
                            model: {
                                uri: data.uri_detail,
                                //minimumPixelSize: 64,
                                maximumScale: 20000,
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                                shadows: Cesium.ShadowMode.ENABLED
                            }
                        });
                    }
                }

                viewer.screenSpaceEventHandler.setInputAction(function (click) {
                    const pickedObject = viewer.scene.pick(click.position);
                    if (Cesium.defined(pickedObject)) {
                        // Clique em marcador de lenda
                        if (pickedObject.id && pickedObject.id.lendaId !== undefined) {
                            showLendaInfobox(pickedObject.id.lendaId);
                            return;
                        }
                        // Clique em OSM
                        if (pickedObject.getProperty) {
                            const elementId = pickedObject.getProperty('elementId');
                            if (elementId && buildingsMap[elementId]) {
                                toggleOsmAndGlb(elementId);
                                return;
                            }
                        }
                        // Clique em GLB
                        if (pickedObject.id && buildingsMap[pickedObject.id.id]) {
                            const id = pickedObject.id.id;
                            showInfobox(id);
                            // Marca para qual id está aberto
                            let infobox = document.getElementById('infobox');
                            if (infobox) infobox.dataset.forId = id;
                            return;
                        }
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            } catch (error) {
                console.error('Erro na inicialização:', error);
            }
        }

        init();
    </script>
</body>

</html>